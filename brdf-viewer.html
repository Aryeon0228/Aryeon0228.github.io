<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real-time PBR Material Simulator - Disney BRDF</title>
<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: #1a1a2e;
color: #fff;
overflow: hidden;
}

#canvas-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: 0;
}

/* Top right menu buttons */
.top-right-menu {
position: fixed;
top: 15px;
right: 15px;
z-index: 100;
display: flex;
gap: 10px;
}

.menu-btn {
background: rgba(30, 30, 50, 0.95);
border: 1px solid rgba(100, 100, 150, 0.3);
border-radius: 8px;
padding: 10px 15px;
color: #fff;
cursor: pointer;
font-size: 13px;
transition: all 0.3s ease;
white-space: nowrap;
}

.menu-btn:hover {
background: rgba(50, 50, 80, 0.95);
border-color: rgba(100, 150, 255, 0.5);
}

.menu-btn i {
margin-right: 6px;
}

/* Control panel */
.control-panel {
position: fixed;
top: 15px;
left: 15px;
width: 320px;
max-height: calc(100vh - 30px);
background: rgba(30, 30, 50, 0.95);
border-radius: 12px;
padding: 20px;
z-index: 50;
overflow-y: auto;
backdrop-filter: blur(10px);
border: 1px solid rgba(100, 100, 150, 0.3);
}

.control-panel::-webkit-scrollbar {
width: 6px;
}

.control-panel::-webkit-scrollbar-track {
background: rgba(0, 0, 0, 0.2);
border-radius: 3px;
}

.control-panel::-webkit-scrollbar-thumb {
background: rgba(100, 100, 150, 0.5);
border-radius: 3px;
}

.panel-title {
font-size: 16px;
font-weight: 600;
margin-bottom: 20px;
padding-bottom: 10px;
border-bottom: 1px solid rgba(100, 100, 150, 0.3);
word-break: keep-all;
overflow-wrap: break-word;
line-height: 1.4;
}

.section {
margin-bottom: 20px;
}

.section-title {
font-size: 13px;
font-weight: 600;
color: #8888aa;
margin-bottom: 12px;
text-transform: uppercase;
letter-spacing: 1px;
word-break: keep-all;
white-space: nowrap;
}

.control-group {
margin-bottom: 12px;
}

.control-label {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 6px;
font-size: 13px;
color: #ccc;
}

.control-value {
color: #88aaff;
font-family: monospace;
}

input[type="range"] {
width: 100%;
height: 6px;
background: rgba(100, 100, 150, 0.3);
border-radius: 3px;
appearance: none;
cursor: pointer;
}

input[type="range"]::-webkit-slider-thumb {
appearance: none;
width: 16px;
height: 16px;
background: #6688ff;
border-radius: 50%;
cursor: pointer;
transition: transform 0.2s;
}

input[type="range"]::-webkit-slider-thumb:hover {
transform: scale(1.2);
}

input[type="color"] {
width: 100%;
height: 35px;
border: none;
border-radius: 6px;
cursor: pointer;
background: transparent;
}

select {
width: 100%;
padding: 10px;
background: rgba(100, 100, 150, 0.2);
border: 1px solid rgba(100, 100, 150, 0.3);
border-radius: 6px;
color: #fff;
font-size: 13px;
cursor: pointer;
appearance: none;
background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
background-repeat: no-repeat;
background-position: right 10px center;
}

select:hover {
border-color: #6688ff;
}

select option {
background: #1a1a2e;
color: #fff;
}

.file-input-wrapper {
position: relative;
margin-bottom: 8px;
}

.file-input-btn {
width: 100%;
padding: 10px;
background: rgba(100, 100, 150, 0.2);
border: 1px dashed rgba(100, 100, 150, 0.5);
border-radius: 6px;
color: #aaa;
cursor: pointer;
text-align: center;
transition: all 0.3s;
font-size: 13px;
}

.file-input-btn:hover {
background: rgba(100, 100, 150, 0.3);
border-color: #6688ff;
color: #fff;
}

.file-input-wrapper input[type="file"] {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
opacity: 0;
cursor: pointer;
}

.file-hint {
font-size: 11px;
color: #777;
margin-top: 4px;
word-break: keep-all;
}

/* Preset modal */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.7);
z-index: 200;
display: none;
justify-content: center;
align-items: center;
backdrop-filter: blur(5px);
}

.modal-overlay.active {
display: flex;
}

.modal {
background: rgba(30, 30, 50, 0.98);
border-radius: 16px;
padding: 30px;
max-width: 500px;
width: 90%;
max-height: 80vh;
overflow-y: auto;
border: 1px solid rgba(100, 100, 150, 0.3);
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
padding-bottom: 15px;
border-bottom: 1px solid rgba(100, 100, 150, 0.3);
}

.modal-title {
font-size: 20px;
font-weight: 600;
word-break: keep-all;
}

.modal-close {
background: none;
border: none;
color: #888;
font-size: 24px;
cursor: pointer;
padding: 5px;
line-height: 1;
}

.modal-close:hover {
color: #fff;
}

.preset-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 12px;
}

.preset-btn {
padding: 15px;
background: rgba(100, 100, 150, 0.2);
border: 1px solid rgba(100, 100, 150, 0.3);
border-radius: 10px;
color: #fff;
cursor: pointer;
transition: all 0.3s;
text-align: left;
}

.preset-btn:hover {
background: rgba(100, 100, 150, 0.4);
border-color: #6688ff;
transform: translateY(-2px);
}

.preset-name {
font-weight: 600;
margin-bottom: 4px;
}

.preset-desc {
font-size: 11px;
color: #888;
}

.preset-color {
width: 30px;
height: 30px;
border-radius: 50%;
margin-bottom: 8px;
border: 2px solid rgba(255, 255, 255, 0.2);
}

/* Info modal style */
.info-modal .modal {
max-width: 700px;
}

.info-section {
margin-bottom: 25px;
}

.info-section h3 {
color: #6688ff;
margin-bottom: 12px;
font-size: 16px;
word-break: keep-all;
}

.info-section p {
line-height: 1.7;
color: #ccc;
font-size: 14px;
text-align: justify;
word-break: keep-all;
}

.info-section ul {
padding-left: 20px;
color: #ccc;
font-size: 14px;
line-height: 1.8;
}

/* Metal reference panel */
.reference-panel {
position: fixed;
top: 70px;
right: 15px;
width: 280px;
background: rgba(30, 30, 50, 0.95);
border-radius: 12px;
padding: 15px;
z-index: 50;
backdrop-filter: blur(10px);
border: 1px solid rgba(100, 100, 150, 0.3);
display: none;
}

.reference-panel.active {
display: block;
}

.reference-title {
font-size: 14px;
font-weight: 600;
margin-bottom: 12px;
display: flex;
justify-content: space-between;
align-items: center;
word-break: keep-all;
}

.reference-close {
background: none;
border: none;
color: #888;
cursor: pointer;
font-size: 16px;
}

.reference-table {
width: 100%;
font-size: 12px;
}

.reference-table th,
.reference-table td {
padding: 6px 8px;
text-align: left;
border-bottom: 1px solid rgba(100, 100, 150, 0.2);
}

.reference-table th {
color: #888;
font-weight: 600;
}

.reference-table td {
color: #ccc;
}

.reference-table .material-name {
color: #88aaff;
}

/* Checkbox toggle */
.toggle-wrapper {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 10px;
}

.toggle-switch {
position: relative;
width: 44px;
height: 24px;
}

.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}

.toggle-slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(100, 100, 150, 0.3);
border-radius: 24px;
transition: 0.3s;
}

.toggle-slider:before {
position: absolute;
content: "";
height: 18px;
width: 18px;
left: 3px;
bottom: 3px;
background: #fff;
border-radius: 50%;
transition: 0.3s;
}

.toggle-switch input:checked + .toggle-slider {
background: #6688ff;
}

.toggle-switch input:checked + .toggle-slider:before {
transform: translateX(20px);
}

/* Section divider */
.section-divider {
height: 1px;
background: rgba(100, 100, 150, 0.3);
margin: 15px 0;
}

/* Common button style */
.action-btn {
width: 100%;
padding: 12px;
background: linear-gradient(135deg, #6688ff 0%, #5566dd 100%);
border: none;
border-radius: 8px;
color: #fff;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
}

.action-btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 20px rgba(102, 136, 255, 0.3);
}

/* Loading indicator */
.loading {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
z-index: 300;
background: rgba(30, 30, 50, 0.95);
padding: 30px 50px;
border-radius: 12px;
text-align: center;
display: none;
}

.loading.active {
display: block;
}

.spinner {
width: 40px;
height: 40px;
border: 3px solid rgba(100, 100, 150, 0.3);
border-top-color: #6688ff;
border-radius: 50%;
animation: spin 1s linear infinite;
margin: 0 auto 15px;
}

@keyframes spin {
to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div id="canvas-container"></div>

<!-- Top right menu buttons -->
<div class="top-right-menu">
<button class="menu-btn" onclick="toggleReference()">
üìñ Metallic Reference
</button>
<button class="menu-btn" onclick="openInfoModal()">
‚ÑπÔ∏è PBR/BRDF Guide
</button>
</div>

<!-- Metallic reference panel -->
<div class="reference-panel" id="referencePanel">
<div class="reference-title">
üìñ Metallic Reference
<button class="reference-close" onclick="toggleReference()">‚úï</button>
</div>
<table class="reference-table">
<thead>
<tr>
<th>Material</th>
<th>Base Color</th>
<th>Metallic</th>
<th>Roughness</th>
</tr>
</thead>
<tbody>
<tr><td class="material-name">Gold</td><td style="color:#ffd700">‚ñ† #FFD700</td><td>1.0</td><td>0.1-0.3</td></tr>
<tr><td class="material-name">Silver</td><td style="color:#c0c0c0">‚ñ† #C0C0C0</td><td>1.0</td><td>0.1-0.2</td></tr>
<tr><td class="material-name">Copper</td><td style="color:#b87333">‚ñ† #B87333</td><td>1.0</td><td>0.2-0.4</td></tr>
<tr><td class="material-name">Aluminum</td><td style="color:#d6d6d6">‚ñ† #D6D6D6</td><td>1.0</td><td>0.3-0.5</td></tr>
<tr><td class="material-name">Chrome</td><td style="color:#e0e0e0">‚ñ† #E0E0E0</td><td>1.0</td><td>0.0-0.1</td></tr>
<tr><td class="material-name">Iron</td><td style="color:#4a4a4a">‚ñ† #4A4A4A</td><td>1.0</td><td>0.4-0.6</td></tr>
<tr><td class="material-name">Titanium</td><td style="color:#878681">‚ñ† #878681</td><td>1.0</td><td>0.3-0.5</td></tr>
<tr><td class="material-name">Plastic</td><td style="color:#cc3333">‚ñ† Varies</td><td>0.0</td><td>0.3-0.5</td></tr>
<tr><td class="material-name">Rubber</td><td style="color:#262626">‚ñ† #262626</td><td>0.0</td><td>0.8-1.0</td></tr>
<tr><td class="material-name">Wood</td><td style="color:#6b3310">‚ñ† #6B3310</td><td>0.0</td><td>0.5-0.8</td></tr>
<tr><td class="material-name">Skin</td><td style="color:#e0ac69">‚ñ† #E0AC69</td><td>0.0</td><td>0.4-0.6</td></tr>
</tbody>
</table>
</div>

<!-- Control panel -->
<div class="control-panel">
<h2 class="panel-title">Real-time PBR Material Simulator</h2>

<!-- Geometry Selection -->
<div class="section">
<div class="section-title">Geometry</div>
<div class="control-group">
<select id="geometrySelect" onchange="changeGeometry()">
<option value="sphere">Sphere</option>
<option value="torusKnot">Torus Knot</option>
<option value="cube">Cube</option>
<option value="cylinder">Cylinder</option>
<option value="cone">Cone</option>
<option value="torus">Torus</option>
<option value="icosahedron">Icosahedron</option>
<option value="octahedron">Octahedron</option>
</select>
</div>
</div>

<div class="section-divider"></div>

<!-- Base Color -->
<div class="section">
<div class="section-title">Base Color</div>
<div class="control-group">
<input type="color" id="baseColor" value="#808080" onchange="updateMaterial()">
</div>
</div>

<!-- Material Presets -->
<div class="section">
<div class="section-title">Material Presets</div>
<div class="control-group">
<select id="presetCategory" onchange="updatePresetList()">
<option value="metals">Metals</option>
<option value="nonmetals">Non-Metals</option>
<option value="special">Special Effects</option>
</select>
</div>
<div class="control-group">
<select id="presetSelect" onchange="applyPresetFromSelect()">
<option value="">-- Select Preset --</option>
</select>
</div>
</div>

<div class="section-divider"></div>

<!-- Material Properties -->
<div class="section">
<div class="section-title">Material Properties</div>

<div class="control-group">
<div class="control-label">
<span>Roughness</span>
<span class="control-value" id="roughnessValue">0.50</span>
</div>
<input type="range" id="roughness" min="0" max="1" step="0.01" value="0.5" oninput="updateMaterial()">
</div>

<div class="control-group">
<div class="control-label">
<span>Metallic</span>
<span class="control-value" id="metallicValue">0.00</span>
</div>
<input type="range" id="metallic" min="0" max="1" step="0.01" value="0" oninput="updateMaterial()">
</div>

<div class="control-group">
<div class="control-label">
<span>Specular (IOR)</span>
<span class="control-value" id="specularValue">0.50</span>
</div>
<input type="range" id="specular" min="0" max="1" step="0.01" value="0.5" oninput="updateMaterial()">
</div>

<div class="control-group">
<div class="control-label">
<span>Clearcoat</span>
<span class="control-value" id="clearcoatValue">0.00</span>
</div>
<input type="range" id="clearcoat" min="0" max="1" step="0.01" value="0" oninput="updateMaterial()">
</div>

<div class="control-group">
<div class="control-label">
<span>Clearcoat Roughness</span>
<span class="control-value" id="clearcoatRoughnessValue">0.00</span>
</div>
<input type="range" id="clearcoatRoughness" min="0" max="1" step="0.01" value="0" oninput="updateMaterial()">
</div>

<div class="control-group">
<div class="control-label">
<span>Sheen</span>
<span class="control-value" id="sheenValue">0.00</span>
</div>
<input type="range" id="sheen" min="0" max="1" step="0.01" value="0" oninput="updateMaterial()">
</div>

<div class="control-group">
<div class="control-label">
<span>Sheen Roughness</span>
<span class="control-value" id="sheenRoughnessValue">1.00</span>
</div>
<input type="range" id="sheenRoughness" min="0" max="1" step="0.01" value="1" oninput="updateMaterial()">
</div>

<div class="control-group">
<div class="control-label">
<span>Iridescence</span>
<span class="control-value" id="iridescenceValue">0.00</span>
</div>
<input type="range" id="iridescence" min="0" max="1" step="0.01" value="0" oninput="updateMaterial()">
</div>

<div class="control-group">
<div class="control-label">
<span>Iridescence IOR</span>
<span class="control-value" id="iridescenceIORValue">1.30</span>
</div>
<input type="range" id="iridescenceIOR" min="1" max="2.333" step="0.01" value="1.3" oninput="updateMaterial()">
</div>
</div>

<div class="section-divider"></div>

<!-- Lighting & Environment -->
<div class="section">
<div class="section-title">Lighting & Environment</div>

<div class="toggle-wrapper">
<span>IOR (Fresnel Effect)</span>
<label class="toggle-switch">
<input type="checkbox" id="iorToggle" checked onchange="toggleIOR()">
<span class="toggle-slider"></span>
</label>
</div>

<div class="control-group">
<div class="control-label">
<span>Environment Map</span>
</div>
<select id="envMapSelect" onchange="changeEnvironment()">
<option value="studio">Studio</option>
<option value="sunset">Sunset</option>
<option value="night">Night</option>
<option value="forest">Forest</option>
<option value="warehouse">Warehouse</option>
</select>
</div>

<div class="control-group">
<div class="control-label">
<span>Main Light Intensity</span>
<span class="control-value" id="mainLightValue">1.50</span>
</div>
<input type="range" id="mainLight" min="0" max="3" step="0.1" value="1.5" oninput="updateLighting()">
</div>

<div class="control-group">
<div class="control-label">
<span>Ambient Light Intensity</span>
<span class="control-value" id="ambientLightValue">0.50</span>
</div>
<input type="range" id="ambientLight" min="0" max="1" step="0.01" value="0.5" oninput="updateLighting()">
</div>

<div class="control-group">
<div class="control-label">
<span>Environment Map Intensity</span>
<span class="control-value" id="envMapValue">1.00</span>
</div>
<input type="range" id="envMapIntensity" min="0" max="3" step="0.1" value="1" oninput="updateMaterial()">
</div>

<div class="toggle-wrapper">
<span>SSAO (Ambient Occlusion)</span>
<label class="toggle-switch">
<input type="checkbox" id="ssaoToggle" checked onchange="toggleSSAO()">
<span class="toggle-slider"></span>
</label>
</div>
</div>

<div class="section-divider"></div>

<!-- Custom Model & Normal Map -->
<div class="section">
<div class="section-title">Custom Model & Normal Map</div>

<div class="control-group">
<div class="control-label">
<span>Custom 3D Model</span>
</div>
<div class="file-input-wrapper">
<div class="file-input-btn">üìÅ Select Model File</div>
<input type="file" id="modelFile" accept=".obj,.gltf,.glb" onchange="loadCustomModel(this)">
</div>
<div class="file-hint">Supported: .OBJ, .GLTF, .GLB</div>
</div>

<div class="control-group">
<div class="control-label">
<span>Normal Map</span>
</div>
<div class="file-input-wrapper">
<div class="file-input-btn">üìÅ Select Normal Map Image</div>
<input type="file" id="normalMapFile" accept=".png,.jpg,.jpeg,.webp,.tga" onchange="loadNormalMap(this)">
</div>
<div class="file-hint">Supported: .PNG, .JPG, .JPEG, .WEBP, .TGA</div>
</div>

<button class="action-btn" onclick="resetModel()" style="margin-top: 10px; background: rgba(100, 100, 150, 0.3);">
üîÑ Reset to Default Model
</button>
</div>
</div>

<!-- Material Presets Modal -->
<div class="modal-overlay" id="presetModal">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title">üé® Material Presets</h3>
<button class="modal-close" onclick="closePresetModal()">‚úï</button>
</div>
<div class="preset-grid">
<button class="preset-btn" onclick="applyPreset('gold')">
<div class="preset-color" style="background: linear-gradient(135deg, #ffd700, #b8860b);"></div>
<div class="preset-name">Gold</div>
<div class="preset-desc">Shiny metallic texture</div>
</button>
<button class="preset-btn" onclick="applyPreset('chrome')">
<div class="preset-color" style="background: linear-gradient(135deg, #e0e0e0, #a0a0a0);"></div>
<div class="preset-name">Chrome</div>
<div class="preset-desc">Mirror-like reflection</div>
</button>
<button class="preset-btn" onclick="applyPreset('copper')">
<div class="preset-color" style="background: linear-gradient(135deg, #b87333, #8b4513);"></div>
<div class="preset-name">Copper</div>
<div class="preset-desc">Warm metallic color</div>
</button>
<button class="preset-btn" onclick="applyPreset('plastic')">
<div class="preset-color" style="background: linear-gradient(135deg, #cc3333, #991111);"></div>
<div class="preset-name">Plastic</div>
<div class="preset-desc">Non-metallic glossy</div>
</button>
<button class="preset-btn" onclick="applyPreset('rubber')">
<div class="preset-color" style="background: linear-gradient(135deg, #333333, #1a1a1a);"></div>
<div class="preset-name">Rubber</div>
<div class="preset-desc">Matte finish</div>
</button>
<button class="preset-btn" onclick="applyPreset('wood')">
<div class="preset-color" style="background: linear-gradient(135deg, #8b4513, #654321);"></div>
<div class="preset-name">Wood</div>
<div class="preset-desc">Natural wood texture</div>
</button>
<button class="preset-btn" onclick="applyPreset('carPaint')">
<div class="preset-color" style="background: linear-gradient(135deg, #cc0000, #990000);"></div>
<div class="preset-name">Car Paint</div>
<div class="preset-desc">Clearcoat applied</div>
</button>
<button class="preset-btn" onclick="applyPreset('brushedMetal')">
<div class="preset-color" style="background: linear-gradient(135deg, #b0b0b0, #808080);"></div>
<div class="preset-name">Brushed Metal</div>
<div class="preset-desc">Hairline finish</div>
</button>
</div>
</div>
</div>

<!-- PBR/BRDF Guide Modal -->
<div class="modal-overlay info-modal" id="infoModal">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title">‚ÑπÔ∏è PBR/BRDF Guide</h3>
<button class="modal-close" onclick="closeInfoModal()">‚úï</button>
</div>

<div class="info-section">
<h3>üé® PBR (Physically Based Rendering)</h3>
<p>
<strong>Physically Based Rendering (PBR)</strong> is a rendering technique that simulates
materials and lighting based on real-world physics laws. It has become the standard
in the game and film industry since the early 2010s.
</p>
<p style="margin-top: 10px;">
<strong>History:</strong> The concept of PBR originated from Jim Kajiya's rendering equation
in the 1980s, and a practical workflow was established with Disney's "Principled BRDF"
announcement in 2012. It is now used as standard in most 3D software including
Unreal Engine, Unity, and Blender.
</p>
<p style="margin-top: 10px;">
<strong>Core Principles:</strong>
</p>
<ul>
<li><strong>Energy Conservation</strong> - Reflected light cannot exceed incident light</li>
<li><strong>Microfacet Theory</strong> - Surface is a collection of microscopic mirrors</li>
<li><strong>Fresnel Effect</strong> - Reflectivity changes with viewing angle</li>
</ul>
</div>

<div class="info-section">
<h3>üí° BRDF (Bidirectional Reflectance Distribution Function)</h3>
<p>
<strong>Bidirectional Reflectance Distribution Function (BRDF)</strong> is a function
that mathematically defines how light reflects from a surface. It takes incident
and reflection angles as input to determine the amount and direction of reflected light.
</p>
<p style="margin-top: 10px;">
<strong>History:</strong> The BRDF concept was first defined by Fred Nicodemus in 1965.
Since then, various BRDF models have been developed including Cook-Torrance (1982),
Oren-Nayar (1994), and GGX (2007).
</p>
<p style="margin-top: 10px;">
<strong>Components:</strong>
</p>
<ul>
<li><strong>Diffuse</strong> - Light that scatters uniformly from the surface</li>
<li><strong>Specular</strong> - Light that reflects like a mirror from the surface</li>
<li><strong>Fresnel</strong> - Reflectivity change based on viewing angle</li>
</ul>
</div>

<div class="info-section">
<h3>‚ú® Disney BRDF (Principled BRDF)</h3>
<p>
<strong>Disney BRDF</strong> is an "artist-friendly" physically based shading model
presented by Brent Burley of Walt Disney Animation Studios in 2012. It was first
introduced in the paper "Physically Based Shading at Disney".
</p>
<p style="margin-top: 10px;">
<strong>Features:</strong> Complex physical parameters have been simplified into
intuitive 0-1 range parameters that artists can easily understand. It pursues
a balance between physical accuracy and ease of use.
</p>
<p style="margin-top: 10px;">
<strong>Key Parameters:</strong>
</p>
<ul>
<li><strong>Base Color</strong> - Base color (shared for Diffuse/Metal)</li>
<li><strong>Metallic</strong> - Metalness (0=non-metal, 1=metal)</li>
<li><strong>Roughness</strong> - Surface roughness (0=smooth, 1=rough)</li>
<li><strong>Specular</strong> - Reflection intensity for non-metals</li>
<li><strong>Clearcoat</strong> - Transparent coating layer (car paint, etc.)</li>
<li><strong>Anisotropic</strong> - Anisotropic reflection (brushed metal)</li>
<li><strong>Subsurface</strong> - Subsurface scattering (skin, wax)</li>
<li><strong>Sheen</strong> - Edge gloss for cloth materials</li>
</ul>
</div>
</div>
</div>

<!-- Loading indicator -->
<div class="loading" id="loading">
<div class="spinner"></div>
<div>Loading...</div>
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

// Make THREE available globally
window.THREE = THREE;

// Global variables
let scene, camera, renderer, controls;
let currentMesh;
let mainLight, fillLight, backLight, ambientLight;
let currentMaterial;
let composer;
let isCustomModel = false;

// Environment presets with HDR URLs from Poly Haven (CC0 License)
const envPresets = {
studio: {
hdrUrl: 'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/studio_small_03_1k.hdr',
backgroundColor: 0x1a1a2e,
mainLightColor: 0xffffff,
fillLightColor: 0x6688ff,
backLightColor: 0xffaa66
},
sunset: {
hdrUrl: 'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/kloofendal_48d_partly_cloudy_puresky_1k.hdr',
backgroundColor: 0x1a0a2e,
mainLightColor: 0xffcc88,
fillLightColor: 0xff8844,
backLightColor: 0xff4400
},
night: {
hdrUrl: 'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/moonlit_golf_1k.hdr',
backgroundColor: 0x000011,
mainLightColor: 0x8888ff,
fillLightColor: 0x4444aa,
backLightColor: 0x2222aa
},
forest: {
hdrUrl: 'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/forest_slope_1k.hdr',
backgroundColor: 0x1a2e1a,
mainLightColor: 0xffffcc,
fillLightColor: 0x88cc88,
backLightColor: 0x66aa66
},
warehouse: {
hdrUrl: 'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/empty_warehouse_01_1k.hdr',
backgroundColor: 0x333333,
mainLightColor: 0xffffff,
fillLightColor: 0xaaaaaa,
backLightColor: 0x666666
}
};

// Preset categories
const presetCategories = {
metals: [
{ id: 'gold', name: 'Gold' },
{ id: 'goldRose', name: 'Rose Gold' },
{ id: 'silver', name: 'Silver' },
{ id: 'chrome', name: 'Chrome' },
{ id: 'copper', name: 'Copper' },
{ id: 'copperOxidized', name: 'Copper (Oxidized)' },
{ id: 'iron', name: 'Iron' },
{ id: 'ironRust', name: 'Iron (Rust)' },
{ id: 'aluminum', name: 'Aluminum' },
{ id: 'aluminumOxidized', name: 'Aluminum (Oxidized)' },
{ id: 'aluminumAnodized', name: 'Aluminum (Anodized)' },
{ id: 'titanium', name: 'Titanium' },
{ id: 'brushedMetal', name: 'Brushed Metal' },
{ id: 'brass', name: 'Brass' },
{ id: 'bronze', name: 'Bronze' }
],
nonmetals: [
{ id: 'plastic', name: 'Plastic (Red)' },
{ id: 'plasticWhite', name: 'Plastic (White)' },
{ id: 'plasticBlack', name: 'Plastic (Black)' },
{ id: 'rubber', name: 'Rubber' },
{ id: 'wood', name: 'Wood' },
{ id: 'woodPolished', name: 'Wood (Polished)' },
{ id: 'leather', name: 'Leather' },
{ id: 'ceramic', name: 'Ceramic' },
{ id: 'glass', name: 'Glass' },
{ id: 'fabric', name: 'Fabric' },
{ id: 'velvet', name: 'Velvet' },
{ id: 'skin', name: 'Skin' }
],
special: [
{ id: 'carPaint', name: 'Car Paint (Red)' },
{ id: 'carPaintBlue', name: 'Car Paint (Blue)' },
{ id: 'carPaintBlack', name: 'Car Paint (Black)' },
{ id: 'pearl', name: 'Pearl' },
{ id: 'iridescent', name: 'Iridescent' },
{ id: 'holographic', name: 'Holographic' },
{ id: 'soapBubble', name: 'Soap Bubble' },
{ id: 'oilSlick', name: 'Oil Slick' },
{ id: 'cdSurface', name: 'CD Surface' },
{ id: 'bismuth', name: 'Bismuth' },
{ id: 'silk', name: 'Silk' },
{ id: 'satin', name: 'Satin' }
]
};

// Presets definition
const presets = {
// Metals
gold: {
color: '#ffd700', metallic: 1.0, roughness: 0.2, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
goldRose: {
color: '#e8b4b8', metallic: 1.0, roughness: 0.25, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
silver: {
color: '#c0c0c0', metallic: 1.0, roughness: 0.15, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
chrome: {
color: '#e0e0e0', metallic: 1.0, roughness: 0.05, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
copper: {
color: '#b87333', metallic: 1.0, roughness: 0.3, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
copperOxidized: {
color: '#4a8c7a', metallic: 0.7, roughness: 0.6, specular: 0.4,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
iron: {
color: '#4a4a4a', metallic: 1.0, roughness: 0.5, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
ironRust: {
color: '#8b4513', metallic: 0.3, roughness: 0.8, specular: 0.3,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
aluminum: {
color: '#d6d6d6', metallic: 1.0, roughness: 0.4, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
aluminumOxidized: {
color: '#a8a8a8', metallic: 0.8, roughness: 0.55, specular: 0.4,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
aluminumAnodized: {
color: '#4169e1', metallic: 0.9, roughness: 0.3, specular: 0.5,
clearcoat: 0.3, clearcoatRoughness: 0.1, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
titanium: {
color: '#878681', metallic: 1.0, roughness: 0.4, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
brushedMetal: {
color: '#b0b0b0', metallic: 1.0, roughness: 0.35, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
brass: {
color: '#b5a642', metallic: 1.0, roughness: 0.25, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
bronze: {
color: '#cd7f32', metallic: 1.0, roughness: 0.35, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},

// Non-metals
plastic: {
color: '#cc3333', metallic: 0, roughness: 0.3, specular: 0.5,
clearcoat: 0.5, clearcoatRoughness: 0.1, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
plasticWhite: {
color: '#f0f0f0', metallic: 0, roughness: 0.35, specular: 0.5,
clearcoat: 0.3, clearcoatRoughness: 0.1, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
plasticBlack: {
color: '#1a1a1a', metallic: 0, roughness: 0.25, specular: 0.5,
clearcoat: 0.6, clearcoatRoughness: 0.05, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
rubber: {
color: '#262626', metallic: 0, roughness: 0.9, specular: 0.5,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
wood: {
color: '#6b3310', metallic: 0, roughness: 0.7, specular: 0.5,
clearcoat: 0.1, clearcoatRoughness: 0.2, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
woodPolished: {
color: '#8b4513', metallic: 0, roughness: 0.3, specular: 0.5,
clearcoat: 0.8, clearcoatRoughness: 0.05, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
leather: {
color: '#3d2314', metallic: 0, roughness: 0.6, specular: 0.4,
clearcoat: 0.1, clearcoatRoughness: 0.3, sheen: 0.3, sheenRoughness: 0.8, iridescence: 0, iridescenceIOR: 1.3
},
ceramic: {
color: '#f5f5f5', metallic: 0, roughness: 0.1, specular: 0.6,
clearcoat: 0.8, clearcoatRoughness: 0.02, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
glass: {
color: '#e0f0ff', metallic: 0, roughness: 0.05, specular: 0.9,
clearcoat: 1.0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.5
},
fabric: {
color: '#6b7b8c', metallic: 0, roughness: 0.8, specular: 0.3,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0.5, sheenRoughness: 0.5, iridescence: 0, iridescenceIOR: 1.3
},
velvet: {
color: '#8b0000', metallic: 0, roughness: 0.9, specular: 0.2,
clearcoat: 0, clearcoatRoughness: 0, sheen: 1.0, sheenRoughness: 0.3, iridescence: 0, iridescenceIOR: 1.3
},
skin: {
color: '#e0ac69', metallic: 0, roughness: 0.5, specular: 0.4,
clearcoat: 0.1, clearcoatRoughness: 0.3, sheen: 0.2, sheenRoughness: 0.6, iridescence: 0, iridescenceIOR: 1.3
},

// Special effects
carPaint: {
color: '#cc0000', metallic: 0, roughness: 0.1, specular: 0.5,
clearcoat: 1.0, clearcoatRoughness: 0.05, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
carPaintBlue: {
color: '#0044cc', metallic: 0, roughness: 0.1, specular: 0.5,
clearcoat: 1.0, clearcoatRoughness: 0.05, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
carPaintBlack: {
color: '#0a0a0a', metallic: 0, roughness: 0.05, specular: 0.5,
clearcoat: 1.0, clearcoatRoughness: 0.02, sheen: 0, sheenRoughness: 1, iridescence: 0, iridescenceIOR: 1.3
},
pearl: {
color: '#f5e6d3', metallic: 0, roughness: 0.25, specular: 0.6,
clearcoat: 0.8, clearcoatRoughness: 0.1, sheen: 0.5, sheenRoughness: 0.5, iridescence: 0.5, iridescenceIOR: 1.5
},
iridescent: {
color: '#c0c0ff', metallic: 0.3, roughness: 0.2, specular: 0.5,
clearcoat: 0.5, clearcoatRoughness: 0.1, sheen: 0.3, sheenRoughness: 0.5, iridescence: 1.0, iridescenceIOR: 1.8
},
holographic: {
color: '#e0e0e0', metallic: 0.5, roughness: 0.1, specular: 0.7,
clearcoat: 1.0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 1.0, iridescenceIOR: 2.2
},
soapBubble: {
color: '#f0f8ff', metallic: 0, roughness: 0.02, specular: 0.9,
clearcoat: 1.0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 1.0, iridescenceIOR: 1.33
},
oilSlick: {
color: '#1a1a2e', metallic: 0.1, roughness: 0.05, specular: 0.7,
clearcoat: 1.0, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 1.0, iridescenceIOR: 1.5
},
cdSurface: {
color: '#c0c0c0', metallic: 0.8, roughness: 0.05, specular: 0.8,
clearcoat: 0.5, clearcoatRoughness: 0, sheen: 0, sheenRoughness: 1, iridescence: 1.0, iridescenceIOR: 2.0
},
bismuth: {
color: '#8b7d6b', metallic: 0.9, roughness: 0.2, specular: 0.6,
clearcoat: 0.3, clearcoatRoughness: 0.1, sheen: 0, sheenRoughness: 1, iridescence: 1.0, iridescenceIOR: 2.333
},
silk: {
color: '#f5deb3', metallic: 0, roughness: 0.4, specular: 0.4,
clearcoat: 0, clearcoatRoughness: 0, sheen: 0.8, sheenRoughness: 0.4, iridescence: 0.2, iridescenceIOR: 1.3
},
satin: {
color: '#b8b8d0', metallic: 0, roughness: 0.35, specular: 0.4,
clearcoat: 0.2, clearcoatRoughness: 0.15, sheen: 0.6, sheenRoughness: 0.5, iridescence: 0.1, iridescenceIOR: 1.3
}
};

// Initialize
function init() {
// Create scene
scene = new THREE.Scene();
scene.background = new THREE.Color(0x1a1a2e);

// Create camera
camera = new THREE.PerspectiveCamera(
45,
window.innerWidth / window.innerHeight,
0.1,
1000
);
camera.position.set(0, 0, 5);

// Create renderer
renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.physicallyCorrectLights = true;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.2;
renderer.outputEncoding = THREE.sRGBEncoding;
document.getElementById('canvas-container').appendChild(renderer.domElement);

// Controls
controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;

// Create material
currentMaterial = new THREE.MeshPhysicalMaterial({
color: 0x808080,
metalness: 0,
roughness: 0.5,
clearcoat: 0,
clearcoatRoughness: 0,
reflectivity: 0.5,
envMapIntensity: 1.0,
sheen: 0,
sheenRoughness: 1.0,
sheenColor: new THREE.Color(0xffffff),
iridescence: 0,
iridescenceIOR: 1.3,
iridescenceThicknessRange: [100, 400]
});

// Create initial geometry (sphere)
createGeometry('sphere');

// Setup lights
setupLights();

// Setup environment
setupEnvironment('studio');

// Initialize preset list
updatePresetList();

// Resize handler
window.addEventListener('resize', onWindowResize);

// Start animation
animate();
}

function createGeometry(type) {
// Remove existing mesh
if (currentMesh) {
scene.remove(currentMesh);
}

let geometry;

switch(type) {
case 'sphere':
geometry = new THREE.SphereGeometry(1.2, 64, 64);
break;
case 'torusKnot':
geometry = new THREE.TorusKnotGeometry(0.8, 0.3, 100, 16);
break;
case 'cube':
geometry = new THREE.BoxGeometry(1.8, 1.8, 1.8, 4, 4, 4);
break;
case 'cylinder':
geometry = new THREE.CylinderGeometry(1, 1, 2, 32);
break;
case 'cone':
geometry = new THREE.ConeGeometry(1, 2, 32);
break;
case 'torus':
geometry = new THREE.TorusGeometry(0.9, 0.4, 32, 100);
break;
case 'icosahedron':
geometry = new THREE.IcosahedronGeometry(1.2, 0);
break;
case 'octahedron':
geometry = new THREE.OctahedronGeometry(1.2, 0);
break;
default:
geometry = new THREE.SphereGeometry(1.2, 64, 64);
}

currentMesh = new THREE.Mesh(geometry, currentMaterial);
scene.add(currentMesh);
isCustomModel = false;
}

function changeGeometry() {
const type = document.getElementById('geometrySelect').value;
createGeometry(type);
}

function setupLights() {
// Main light
mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
mainLight.position.set(5, 5, 5);
scene.add(mainLight);

// Fill light
fillLight = new THREE.DirectionalLight(0x6688ff, 0.8);
fillLight.position.set(-5, -3, 3);
scene.add(fillLight);

// Back light
backLight = new THREE.DirectionalLight(0xffaa66, 0.5);
backLight.position.set(0, -5, -3);
scene.add(backLight);

// Ambient light
ambientLight = new THREE.AmbientLight(0x404040, 0.5);
scene.add(ambientLight);
}

function setupEnvironment(preset) {
const env = envPresets[preset] || envPresets.studio;

// Show loading indicator
const loading = document.getElementById('loading');
if (loading) loading.classList.add('active');

// PMREMGenerator for environment map
const pmremGenerator = new THREE.PMREMGenerator(renderer);
pmremGenerator.compileEquirectangularShader();

// Load HDR environment map
const rgbeLoader = new RGBELoader();
rgbeLoader.load(env.hdrUrl, function(texture) {
texture.mapping = THREE.EquirectangularReflectionMapping;

// Generate environment map from HDR
const envMap = pmremGenerator.fromEquirectangular(texture).texture;

scene.environment = envMap;
scene.background = envMap; // Use HDR as background too!

// Update light colors to match environment
mainLight.color.set(env.mainLightColor);
fillLight.color.set(env.fillLightColor);
backLight.color.set(env.backLightColor);

texture.dispose();
pmremGenerator.dispose();

// Hide loading indicator
if (loading) loading.classList.remove('active');
}, undefined, function(error) {
console.error('HDR load error:', error);
// Fallback to solid color background
scene.background = new THREE.Color(env.backgroundColor);
if (loading) loading.classList.remove('active');
});
}

function changeEnvironment() {
const preset = document.getElementById('envMapSelect').value;
setupEnvironment(preset);
}

function animate() {
requestAnimationFrame(animate);
controls.update();

// Slight auto rotation
if (currentMesh && !isCustomModel) {
currentMesh.rotation.y += 0.002;
}

renderer.render(scene, camera);
}

function onWindowResize() {
camera.aspect = window.innerWidth / window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(window.innerWidth, window.innerHeight);
}

// Update material
function updateMaterial() {
const color = document.getElementById('baseColor').value;
const roughness = parseFloat(document.getElementById('roughness').value);
const metallic = parseFloat(document.getElementById('metallic').value);
const specular = parseFloat(document.getElementById('specular').value);
const clearcoat = parseFloat(document.getElementById('clearcoat').value);
const clearcoatRoughness = parseFloat(document.getElementById('clearcoatRoughness').value);
const sheen = parseFloat(document.getElementById('sheen').value);
const sheenRoughness = parseFloat(document.getElementById('sheenRoughness').value);
const iridescence = parseFloat(document.getElementById('iridescence').value);
const iridescenceIOR = parseFloat(document.getElementById('iridescenceIOR').value);
const envMapIntensity = parseFloat(document.getElementById('envMapIntensity').value);

// Update value displays
document.getElementById('roughnessValue').textContent = roughness.toFixed(2);
document.getElementById('metallicValue').textContent = metallic.toFixed(2);
document.getElementById('specularValue').textContent = specular.toFixed(2);
document.getElementById('clearcoatValue').textContent = clearcoat.toFixed(2);
document.getElementById('clearcoatRoughnessValue').textContent = clearcoatRoughness.toFixed(2);
document.getElementById('sheenValue').textContent = sheen.toFixed(2);
document.getElementById('sheenRoughnessValue').textContent = sheenRoughness.toFixed(2);
document.getElementById('iridescenceValue').textContent = iridescence.toFixed(2);
document.getElementById('iridescenceIORValue').textContent = iridescenceIOR.toFixed(2);
document.getElementById('envMapValue').textContent = envMapIntensity.toFixed(2);

// Update material
currentMaterial.color.set(color);
currentMaterial.roughness = roughness;
currentMaterial.metalness = metallic;
currentMaterial.reflectivity = specular;
currentMaterial.clearcoat = clearcoat;
currentMaterial.clearcoatRoughness = clearcoatRoughness;
currentMaterial.sheen = sheen;
currentMaterial.sheenRoughness = sheenRoughness;
currentMaterial.iridescence = iridescence;
currentMaterial.iridescenceIOR = iridescenceIOR;
currentMaterial.envMapIntensity = envMapIntensity;

// Calculate IOR (specular 0-1 -> IOR 1.0-1.8) - only if IOR is enabled
const iorEnabled = document.getElementById('iorToggle').checked;
if (iorEnabled) {
currentMaterial.ior = 1.0 + specular * 0.8;
currentMaterial.reflectivity = specular;
} else {
currentMaterial.ior = 1.0;
currentMaterial.reflectivity = 0;
}
}

// Update lighting
function updateLighting() {
const mainIntensity = parseFloat(document.getElementById('mainLight').value);
const ambientIntensity = parseFloat(document.getElementById('ambientLight').value);

document.getElementById('mainLightValue').textContent = mainIntensity.toFixed(2);
document.getElementById('ambientLightValue').textContent = ambientIntensity.toFixed(2);

mainLight.intensity = mainIntensity;
fillLight.intensity = mainIntensity * 0.6;
backLight.intensity = mainIntensity * 0.4;
ambientLight.intensity = ambientIntensity;
}

// SSAO toggle (simulation)
function toggleSSAO() {
const enabled = document.getElementById('ssaoToggle').checked;
// In Three.js, SSAO requires post-processing, so we simulate with tone mapping
renderer.toneMappingExposure = enabled ? 1.2 : 1.0;
}

// IOR toggle
function toggleIOR() {
const enabled = document.getElementById('iorToggle').checked;
const specular = parseFloat(document.getElementById('specular').value);
if (enabled) {
// IOR enabled: use specular value to calculate IOR
currentMaterial.ior = 1.0 + specular * 0.8;
currentMaterial.reflectivity = specular;
// Restore environment background
if (scene.environment) {
scene.background = scene.environment;
}
} else {
// IOR disabled: set to minimum (no Fresnel effect)
currentMaterial.ior = 1.0;
currentMaterial.reflectivity = 0;
// Hide background (solid color)
scene.background = new THREE.Color(0x1a1a2e);
}
currentMaterial.needsUpdate = true;
}

// Load custom model
function loadCustomModel(input) {
const file = input.files[0];
if (!file) return;

showLoading(true);
const fileName = file.name.toLowerCase();
const url = URL.createObjectURL(file);

// Remove existing mesh
if (currentMesh) scene.remove(currentMesh);

if (fileName.endsWith('.obj')) {
const loader = new OBJLoader();
loader.load(url, function(object) {
object.traverse(function(child) {
if (child.isMesh) {
child.material = currentMaterial;
}
});

// Center and scale
const box = new THREE.Box3().setFromObject(object);
const center = box.getCenter(new THREE.Vector3());
const size = box.getSize(new THREE.Vector3());
const maxDim = Math.max(size.x, size.y, size.z);
const scale = 3 / maxDim;

object.position.sub(center);
object.scale.multiplyScalar(scale);

currentMesh = object;
isCustomModel = true;
scene.add(object);
showLoading(false);
URL.revokeObjectURL(url);
}, undefined, function(error) {
console.error(error);
showLoading(false);
alert('Failed to load model');
});
} else if (fileName.endsWith('.gltf') || fileName.endsWith('.glb')) {
const loader = new GLTFLoader();
loader.load(url, function(gltf) {
gltf.scene.traverse(function(child) {
if (child.isMesh) {
child.material = currentMaterial;
}
});

// Center and scale
const box = new THREE.Box3().setFromObject(gltf.scene);
const center = box.getCenter(new THREE.Vector3());
const size = box.getSize(new THREE.Vector3());
const maxDim = Math.max(size.x, size.y, size.z);
const scale = 3 / maxDim;

gltf.scene.position.sub(center);
gltf.scene.scale.multiplyScalar(scale);

currentMesh = gltf.scene;
isCustomModel = true;
scene.add(gltf.scene);
showLoading(false);
URL.revokeObjectURL(url);
}, undefined, function(error) {
console.error(error);
showLoading(false);
alert('Failed to load model');
});
}
}

// Load normal map
function loadNormalMap(input) {
const file = input.files[0];
if (!file) return;

const url = URL.createObjectURL(file);
const textureLoader = new THREE.TextureLoader();

textureLoader.load(url, function(texture) {
currentMaterial.normalMap = texture;
currentMaterial.normalScale.set(1, 1);
currentMaterial.needsUpdate = true;
URL.revokeObjectURL(url);
}, undefined, function(error) {
console.error(error);
alert('Failed to load normal map');
});
}

// Reset to default model
function resetModel() {
// Reset to sphere
document.getElementById('geometrySelect').value = 'sphere';
createGeometry('sphere');

// Remove normal map
currentMaterial.normalMap = null;
currentMaterial.needsUpdate = true;

// Reset file inputs
document.getElementById('modelFile').value = '';
document.getElementById('normalMapFile').value = '';
}

// Update preset list based on category
function updatePresetList() {
const category = document.getElementById('presetCategory').value;
const select = document.getElementById('presetSelect');
const items = presetCategories[category] || [];

select.innerHTML = '<option value="">-- Select Preset --</option>';
items.forEach(item => {
const option = document.createElement('option');
option.value = item.id;
option.textContent = item.name;
select.appendChild(option);
});
}

// Apply preset from dropdown
function applyPresetFromSelect() {
const name = document.getElementById('presetSelect').value;
if (name) {
applyPreset(name);
}
}

// Apply preset
function applyPreset(name) {
const preset = presets[name];
if (!preset) return;

document.getElementById('baseColor').value = preset.color;
document.getElementById('roughness').value = preset.roughness;
document.getElementById('metallic').value = preset.metallic;
document.getElementById('specular').value = preset.specular;
document.getElementById('clearcoat').value = preset.clearcoat;
document.getElementById('clearcoatRoughness').value = preset.clearcoatRoughness;
document.getElementById('sheen').value = preset.sheen;
document.getElementById('sheenRoughness').value = preset.sheenRoughness;
document.getElementById('iridescence').value = preset.iridescence;
document.getElementById('iridescenceIOR').value = preset.iridescenceIOR;

updateMaterial();

// Close modal if open
const modal = document.getElementById('presetModal');
if (modal.classList.contains('active')) {
closePresetModal();
}
}

// Reference panel toggle
function toggleReference() {
const panel = document.getElementById('referencePanel');
panel.classList.toggle('active');
}

// Preset modal
function openPresetModal() {
document.getElementById('presetModal').classList.add('active');
}

function closePresetModal() {
document.getElementById('presetModal').classList.remove('active');
}

// Info modal
function openInfoModal() {
document.getElementById('infoModal').classList.add('active');
}

function closeInfoModal() {
document.getElementById('infoModal').classList.remove('active');
}

// Show loading
function showLoading(show) {
document.getElementById('loading').classList.toggle('active', show);
}

// Close modal on outside click
document.addEventListener('click', function(e) {
if (e.target.classList.contains('modal-overlay')) {
e.target.classList.remove('active');
}
});

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
if (e.key === 'Escape') {
document.querySelectorAll('.modal-overlay').forEach(modal => {
modal.classList.remove('active');
});
}
});

// Expose functions to window for HTML event handlers
window.changeGeometry = changeGeometry;
window.updateMaterial = updateMaterial;
window.updatePresetList = updatePresetList;
window.applyPresetFromSelect = applyPresetFromSelect;
window.applyPreset = applyPreset;
window.updateLighting = updateLighting;
window.changeEnvironment = changeEnvironment;
window.toggleSSAO = toggleSSAO;
window.toggleIOR = toggleIOR;
window.loadCustomModel = loadCustomModel;
window.loadNormalMap = loadNormalMap;
window.resetModel = resetModel;
window.toggleReference = toggleReference;
window.openPresetModal = openPresetModal;
window.closePresetModal = closePresetModal;
window.openInfoModal = openInfoModal;
window.closeInfoModal = closeInfoModal;

// Initialize
init();
</script>
</body>
</html>
